//! # demo05 - ç»¼åˆèƒ½åŠ›æ¼”ç¤º
//!
//! æœ¬ç¤ºä¾‹å°†æ¡†æ¶çš„å››é¡¹æ ¸å¿ƒèƒ½åŠ›æ•´åˆåˆ°ä¸€ä¸ªçœŸå®åœºæ™¯ä¸­ï¼š
//!
//! - **å·¥å…·è°ƒç”¨**ï¼šæ•°å­¦è¿ç®—å·¥å…·ï¼ˆåŠ å‡ä¹˜é™¤ï¼‰
//! - **ä»»åŠ¡è§„åˆ’**ï¼šå°†å¤æ‚è´¹ç”¨è®¡ç®—æ‹†åˆ†ä¸ºå¹¶è¡Œå­ä»»åŠ¡
//! - **Human-in-Loop**ï¼šæ¯äººåˆ†æ‘Šé‡‘é¢ï¼ˆdivideï¼‰æ‰§è¡Œå‰éœ€äººå·¥ç¡®è®¤
//! - **ä¸Šä¸‹æ–‡å‹ç¼©**ï¼šæ»‘åŠ¨çª—å£è‡ªåŠ¨ç®¡ç†é•¿å¯¹è¯çš„ token ç”¨é‡
//!

use echo_agent::agent::Agent;
use echo_agent::agent::react_agent::{AgentConfig, ReactAgent};
use echo_agent::compression::compressor::SlidingWindowCompressor;
use echo_agent::tools::others::math::{AddTool, DivideTool, MultiplyTool, SubtractTool};

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    tracing_subscriber::fmt()
        .with_max_level(tracing::Level::INFO)
        .init();

    println!("ğŸ§ª demo05 - ç»¼åˆèƒ½åŠ›æ¼”ç¤ºï¼ˆå·¥å…· + ä»»åŠ¡è§„åˆ’ + ä¸Šä¸‹æ–‡å‹ç¼© + Human-in-Loopï¼‰\n");

    let system_prompt = r#"ä½ æ˜¯ä¸€ä¸ªå‡ºå·®è´¹ç”¨æ ¸ç®—åŠ©æ‰‹ï¼Œéœ€è¦ç»¼åˆè¿ç”¨ä»¥ä¸‹æ‰€æœ‰èƒ½åŠ›å®Œæˆä»»åŠ¡ã€‚

**å·¥ä½œæµç¨‹**ï¼š
1. å…ˆç”¨ think åˆ†æè´¹ç”¨ç»“æ„ï¼Œå†ç”¨ plan + create_task å°†å„è´¹ç”¨ç±»åˆ«æ‹†æˆå¹¶è¡Œå­ä»»åŠ¡
2. ç‹¬ç«‹çš„è´¹ç”¨è®¡ç®—ä»»åŠ¡ä¸è®¾ä¾èµ–ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼›æ±‡æ€»ç±»ä»»åŠ¡ä¾èµ–æ‰€æœ‰è´¹ç”¨ä»»åŠ¡
3. ä½¿ç”¨ add / subtract / multiply å·¥å…·å®Œæˆè®¡ç®—ï¼Œç”¨ update_task è®°å½•ç»“æœ
4. æ‰€æœ‰è´¹ç”¨ç®—å‡ºåï¼Œä½¿ç”¨ divide å·¥å…·è®¡ç®—äººå‡åˆ†æ‘Šé‡‘é¢
5. æœ€åç”¨ final_answer ç»™å‡ºå®Œæ•´çš„è´¹ç”¨æŠ¥å‘Š

**é‡è¦è§„åˆ™**ï¼š
- æ¯æ¬¡å›å¤å°½å¯èƒ½å¹¶è¡Œè°ƒç”¨å¤šä¸ªå·¥å…·
- divide å·¥å…·æ‰§è¡Œå‰éœ€è¦äººå·¥ç¡®è®¤ï¼ˆè¿™æ˜¯è®¾è®¡è¡Œä¸ºï¼Œè¯·æ­£å¸¸è°ƒç”¨ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¼¹å‡ºç¡®è®¤ï¼‰
- æŠ¥å‘Šä¸­éœ€åŒ…å«ï¼šå„ç±»æ€»é¢ã€è´¹ç”¨æ€»è®¡ã€äººå‡åˆ†æ‘Šã€ä¸é¢„ç®—çš„å·®é¢
"#;

    let config = AgentConfig::new("qwen3-max", "expense_agent", system_prompt)
        .enable_tool(true)
        .enable_task(true)
        .enable_human_in_loop(true)
        .enable_subagent(false)
        // ä¸Šä¸‹æ–‡è¶…è¿‡ 3000 token æ—¶è‡ªåŠ¨è§¦å‘æ»‘åŠ¨çª—å£å‹ç¼©
        .token_limit(3000)
        .verbose(true)
        .max_iterations(40);

    let mut agent = ReactAgent::new(config);

    // æ™®é€šæ•°å­¦å·¥å…·ï¼ˆæ— éœ€å®¡æ‰¹ï¼‰
    agent.add_tool(Box::new(AddTool));
    agent.add_tool(Box::new(SubtractTool));
    agent.add_tool(Box::new(MultiplyTool));

    // divide å·¥å…·æ ‡è®°ä¸º"éœ€è¦äººå·¥å®¡æ‰¹"ï¼šæ¯æ¬¡è°ƒç”¨å‰ç»ˆç«¯ä¼šå¼¹å‡º y/n ç¡®è®¤
    // ç”¨äºæ¨¡æ‹Ÿ"äººå‡åˆ†æ‘Š"è¿™ç±»æ¶‰åŠèµ„é‡‘åˆ†é…çš„æ•æ„Ÿæ“ä½œ
    agent.add_need_appeal_tool(Box::new(DivideTool));

    // æ»‘åŠ¨çª—å£å‹ç¼©ï¼šè¶…é™åä¿ç•™æœ€è¿‘ 20 æ¡æ¶ˆæ¯ï¼Œé¿å…é•¿ä»»åŠ¡è§„åˆ’æŠŠ context æ’‘çˆ†
    agent.set_compressor(SlidingWindowCompressor::new(20));

    let task = r#"æˆ‘ä»¬å›¢é˜Ÿ 5 äººå»åŒ—äº¬å‡ºå·® 3 å¤©ï¼Œè¯·å¸®æˆ‘æ ¸ç®—æœ¬æ¬¡å‡ºå·®è´¹ç”¨ï¼š

ã€ä½å®¿ã€‘æ¯æ™šæ¯äºº 380 å…ƒï¼Œå…± 3 æ™š
ã€é¤é¥®ã€‘æ¯äººæ¯å¤© 120 å…ƒï¼Œå…± 3 å¤©
ã€äº¤é€šã€‘å¾€è¿”æœºç¥¨æ¯äºº 1350 å…ƒï¼›å¸‚å†…äº¤é€šå…¨å›¢æ€»è®¡ 420 å…ƒ
ã€ä¼šè®®ã€‘ä¼šè®®å®¤ç§Ÿé‡‘ 800 å…ƒï¼Œè®¾å¤‡ç§Ÿé‡‘ 250 å…ƒ
ã€å…¬å¸é¢„ç®—ã€‘æœ¬æ¬¡å‡ºå·®å®¡æ‰¹æ€»é¢„ç®—ä¸º 25000 å…ƒ

è¯·è®¡ç®—ï¼š
1. ä½å®¿ã€é¤é¥®ã€äº¤é€šã€ä¼šè®®å„ç±»è´¹ç”¨çš„å›¢é˜Ÿæ€»é¢
2. æœ¬æ¬¡å‡ºå·®æ€»è´¹ç”¨
3. æ¯äººå¹³å‡åˆ†æ‘Šé‡‘é¢ï¼ˆè°ƒç”¨ divide æ—¶ç³»ç»Ÿä¼šè¯·ä½ ç¡®è®¤ï¼‰
4. ä¸é¢„ç®—çš„å·®é¢ï¼ˆè¶…æ”¯æˆ–ç»“ä½™ï¼‰"#;

    let result = agent.execute(task).await;

    println!("\nâœ… æœ€ç»ˆç»“æœ:\n{:?}", result);
    Ok(())
}
